<div class="popup-purge">
  <h2>ğŸ§¹ Sauvegarde & purge de fin dâ€™annÃ©e</h2>
  <p>
    Cette opÃ©ration va :
    <ul>
      <li>ğŸ“ Sauvegarder tous les comptes <strong>demandeurs</strong> (hors comptes systÃ¨me) dans un fichier ZIP.</li>
      <li>ğŸ—‘ï¸ Supprimer tous ces comptes de la base pour prÃ©parer la prochaine importation.</li>
    </ul>
  </p>
  <button id="btnLancerPurge">Lancer la sauvegarde & purge</button>
  <div id="purgeResultat" style="margin-top: 1em;"></div>
</div>

<script>
document.getElementById("btnLancerPurge").addEventListener("click", async () => {
  if (!confirm("Confirmer la purge et la sauvegarde des comptes demandeurs ?")) return;

  const btn = document.getElementById("btnLancerPurge");
  btn.disabled = true;
  btn.innerText = "Traitement en cours...";

  const res = await fetch("/api/purge-demand", { method: "POST" });
  const result = await res.json();
  const div = document.getElementById("purgeResultat");

  if (res.ok) {
    div.innerHTML = `
      âœ… <strong>${result.sauvegardes}</strong> comptes sauvegardÃ©s et supprimÃ©s.<br>
      ğŸ“¦ <a href="${result.url}" download>TÃ©lÃ©charger lâ€™archive</a>
    `;
  } else {
    div.innerHTML = `<p style="color:red;">Erreur : ${result.erreur || "inconnue"}</p>`;
  }

  btn.disabled = false;
  btn.innerText = "Lancer la sauvegarde & purge";
});
</script>
